<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Messenger</title>
    <link rel="stylesheet" href="style.css">
    <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –≤–∞—à–∏–º script.js -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1200px;
            height: 800px;
            overflow: hidden;
            display: flex;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            width: 100%;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
        }

        .auth-form h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .auth-form p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .user-id-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .user-id-display strong {
            color: #667eea;
            font-size: 18px;
            word-break: break-all;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–æ–≤ */
        .chat-container {
            display: none;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-info h3 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .user-id {
            font-size: 14px;
            opacity: 0.9;
            word-break: break-all;
        }

        .search-box {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            font-size: 14px;
        }

        .contacts {
            flex: 1;
            overflow-y: auto;
        }

        .contact {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
        }

        .contact:hover {
            background: #e9ecef;
        }

        .contact.active {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }

        .contact-info h4 {
            margin-bottom: 3px;
            color: #333;
        }

        .contact-info p {
            font-size: 12px;
            color: #666;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
        }

        .messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .message-input {
            padding: 20px 25px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            font-size: 14px;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .back-btn {
            margin-bottom: 20px;
            background: #f8f9fa;
            color: #333;
        }

        .back-btn:hover {
            background: #e9ecef;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="authPage" class="auth-container">
            <div class="auth-form">
                <h1>üì± Simple Messenger</h1>
                <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                
                <div id="registerForm">
                    <div class="form-group">
                        <label for="username">–í–∞—à–µ –∏–º—è:</label>
                        <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
                    </div>
                    <button onclick="register()" class="btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>

                <div id="loginForm" style="display: none;">
                    <div class="form-group">
                        <label for="userID">–í–∞—à ID:</label>
                        <input type="text" id="userID" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID">
                        <div id="loginError" class="error"></div>
                    </div>
                    <button onclick="login()" class="btn">–í–æ–π—Ç–∏</button>
                    <button onclick="showRegister()" class="btn back-btn">–ù–∞–∑–∞–¥ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
                </div>

                <div id="userInfo" class="user-id-display" style="display: none;">
                    <p>–í–∞—à ID –¥–ª—è –≤—Ö–æ–¥–∞:</p>
                    <strong id="displayUserID"></strong>
                    <p style="margin-top: 10px; font-size: 14px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç ID! –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞.</p>
                    <button onclick="goToChat()" class="btn" style="margin-top: 15px;">–ü–µ—Ä–µ–π—Ç–∏ –∫ —á–∞—Ç–∞–º</button>
                    <button onclick="logout()" class="btn back-btn" style="margin-top: 10px;">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–æ–≤ -->
        <div id="chatPage" class="chat-container">
            <div class="sidebar">
                <div class="user-info">
                    <h3 id="currentUserName"></h3>
                    <div class="user-id">ID: <span id="currentUserID"></span></div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchUser" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID" oninput="searchUser()">
                </div>

                <div class="contacts" id="contactsList">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <div class="contact-avatar" id="currentChatAvatar">?</div>
                    <div>
                        <h3 id="currentChatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <p id="currentChatStatus"></p>
                    </div>
                </div>

                <div class="messages" id="messagesContainer">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è
                    </div>
                </div>

                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="send-btn">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let users = JSON.parse(localStorage.getItem('messengerUsers')) || {};
        let messages = JSON.parse(localStorage.getItem('messengerMessages')) || {};
        let currentUser = null;
        let currentChat = null;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateUserID() {
            return 'USER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function register() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }

            const userID = generateUserID();
            currentUser = {
                id: userID,
                username: username,
                createdAt: new Date().toISOString()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            users[userID] = currentUser;
            localStorage.setItem('messengerUsers', JSON.stringify(users));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('displayUserID').textContent = userID;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // –í—Ö–æ–¥ –ø–æ ID
        function login() {
            const userID = document.getElementById('userID').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!userID) {
                errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID';
                return;
            }

            if (users[userID]) {
                currentUser = users[userID];
                goToChat();
            } else {
                errorDiv.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω';
            }
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('username').value = '';
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞—Ç–∞–º
        function goToChat() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('chatPage').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            document.getElementById('currentUserName').textContent = currentUser.username;
            document.getElementById('currentUserID').textContent = currentUser.id;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
            loadContacts();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ)
        function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';

            Object.values(users).forEach(user => {
                if (user.id !== currentUser.id) {
                    const lastMessage = getLastMessage(user.id);
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact';
                    contactElement.onclick = () => selectChat(user);
                    
                    contactElement.innerHTML = `
                        <div class="contact-avatar">${user.username.charAt(0)}</div>
                        <div class="contact-info">
                            <h4>${user.username}</h4>
                            <p>${lastMessage ? lastMessage.text : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</p>
                        </div>
                    `;
                    
                    contactsList.appendChild(contactElement);
                }
            });
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function searchUser() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');

            contacts.forEach(contact => {
                const username = contact.querySelector('h4').textContent.toLowerCase();
                const userID = contact.querySelector('p').textContent.toLowerCase();
                
                if (username.includes(searchTerm) || userID.includes(searchTerm)) {
                    contact.style.display = 'flex';
                } else {
                    contact.style.display = 'none';
                }
            });
        }

        // –í—ã–±–æ—Ä —á–∞—Ç–∞
        function selectChat(user) {
            currentChat = user;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            document.getElementById('currentChatName').textContent = user.username;
            document.getElementById('currentChatAvatar').textContent = user.username.charAt(0);
            document.getElementById('currentChatStatus').textContent = '–í —Å–µ—Ç–∏';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages(user.id);
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
            document.querySelectorAll('.contact').forEach(contact => {
                contact.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function getLastMessage(userId) {
            const chatId = [currentUser.id, userId].sort().join('_');
            const chatMessages = messages[chatId];
            return chatMessages ? chatMessages[chatMessages.length - 1] : null;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages(userId) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            const chatId = [currentUser.id, userId].sort().join('_');
            const chatMessages = messages[chatId] || [];

            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å ${users[userId].username}
                    </div>
                `;
                return;
            }

            chatMessages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.senderId === currentUser.id ? 'sent' : 'received'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        ${msg.text}
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            if (!currentChat) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±—â–µ–Ω–∏—è');
                return;
            }

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            const message = {
                senderId: currentUser.id,
                receiverId: currentChat.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const chatId = [currentUser.id, currentChat.id].sort().join('_');
            if (!messages[chatId]) {
                messages[chatId] = [];
            }
            messages[chatId].push(message);
            localStorage.setItem('messengerMessages', JSON.stringify(messages));

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            loadMessages(currentChat.id);
            loadContacts(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            input.focus();
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const savedUserID = localStorage.getItem('currentUserID');
            if (savedUserID && users[savedUserID]) {
                currentUser = users[savedUserID];
                goToChat();
            }
        };
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
const socket = io('http://localhost:3000');

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function register() {
    const username = document.getElementById('username').value.trim();
    
    if (!username) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
        return;
    }

    const userID = generateUserID();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    socket.emit('register', {
        userId: userID,
        username: username
    });

    socket.on('registered', (data) => {
        currentUser = {
            id: data.userId,
            username: data.username
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('displayUserID').textContent = data.userId;
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
function loadContacts() {
    socket.emit('getUsers');
    
    socket.on('userList', (users) => {
        const contactsList = document.getElementById('contactsList');
        contactsList.innerHTML = '';

        users.forEach(user => {
            if (user.id !== currentUser.id) {
                const contactElement = document.createElement('div');
                contactElement.className = 'contact';
                contactElement.onclick = () => selectChat(user);
                
                contactElement.innerHTML = `
                    <div class="contact-avatar">${user.username.charAt(0)}</div>
                    <div class="contact-info">
                        <h4>${user.username}</h4>
                        <p>ID: ${user.id}</p>
                    </div>
                `;
                
                contactsList.appendChild(contactElement);
            }
        });
    });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
function sendMessage() {
    if (!currentChat) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±—â–µ–Ω–∏—è');
        return;
    }

    const input = document.getElementById('messageInput');
    const text = input.value.trim();

    if (!text) return;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    socket.emit('sendMessage', {
        from: currentUser.id,
        to: currentChat.id,
        text: text
    });

    socket.on('messageSent', (message) => {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        addMessageToUI(message, true);
        input.value = '';
        input.focus();
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
socket.on('newMessage', (message) => {
    if (currentChat && (message.from === currentChat.id || message.to === currentChat.id)) {
        addMessageToUI(message, false);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    loadContacts();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
function loadMessages(userId) {
    socket.emit('getMessages', {
        userId: currentUser.id,
        otherUserId: userId
    });

    socket.on('messageHistory', (messages) => {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';

        if (messages.length === 0) {
            messagesContainer.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å ${users[userId]?.username || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'}
                </div>
            `;
            return;
        }

        messages.forEach(msg => {
            addMessageToUI(msg, msg.from === currentUser.id);
        });
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
function addMessageToUI(message, isSent) {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
    
    const time = new Date(message.timestamp).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    messageElement.innerHTML = `
        <div class="message-content">
            ${message.text}
            <div class="message-time">${time}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ö–æ–¥
function login() {
    const userID = document.getElementById('userID').value.trim();
    const errorDiv = document.getElementById('loginError');

    if (!userID) {
        errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID';
        return;
    }

    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        const userData = JSON.parse(savedUser);
        if (userData.id === userID) {
            currentUser = userData;
            socket.emit('register', {
                userId: userID,
                username: userData.username
            });
            goToChat();
            return;
        }
    }
    
    errorDiv.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ.';
}
    </script>
</body>
</html>
